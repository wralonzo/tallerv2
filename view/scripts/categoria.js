var tabla;

function init() {
  mostrarform(false);
  listar();

  $("#formulario").on("submit", function (e) {
    guardaryeditar(e);
  });
}

function limpiar() {
  $("#idcategoria").val("");
  $("#nombre").val("");
  $("#descripcion").val("");
}

function mostrarform(flag) {
  limpiar();
  if (flag) {
    $("#listadoregistros").hide();
    $("#formularioregistros").show();
    $("#btnGuardar").prop("disabled", false);
    $("#btnagregar").hide();
  } else {
    $("#listadoregistros").show();
    $("#formularioregistros").hide();
    $("#btnagregar").show();
  }
}

function cancelarform() {
  limpiar();
  mostrarform(false);
}

function listar() {
  tabla = $("#tbllistado")
    .dataTable({
      lengthMenu: [
        [5, 10, 25, 50, -1],
        ["5 filas", "10 filas", "25 filas", "50 filas", "Mostrar todo"],
      ],
      buttons: [
        {
          extend: "pageLength",
          text: "Longitud de la página",
        },
        {
          extend: "print",
          text: "IMPRIMIR",
          title: "Categorías del Sistema  BYTE SEVEN",
        },
        {
          extend: "pdf",
          text: "DESCARGAR PDF",
          title: "Categorías del Sistema BYTE SEVEN",
        },
      ],
      ajax: {
        url: "../controller/categoria.php?op=listar",
        type: "get",
        dataType: "json",
        error: function (e) {
          console.log(e.responseText);
        },
      },
      bDestroy: true,
      iDisplayLength: 20, //Paginación
      order: [[0, "desc"]],
    })
    .DataTable();
}

//Función para guardar o editar

function guardaryeditar(e) {
  e.preventDefault(); //No se activará la acción predeterminada del evento
  $("#btnGuardar").prop("disabled", true);
  var formData = new FormData($("#formulario")[0]);

  $.ajax({
    url: "../controller/categoria.php?op=guardaryeditar",
    type: "POST",
    data: formData,
    contentType: false,
    processData: false,

    success: function (datos) {
      if (datos == 1) {
        Swal.fire({
          position: "top-end",
          icon: "success",
          title: "Categoría registrada",
          showConfirmButton: false,
          timer: 1500,
        });
      } else if (datos == 3) {
        Swal.fire({
          position: "top-end",
          icon: "success",
          title: "Categoría actualizada",
          showConfirmButton: false,
          timer: 1500,
        });
      } else if (datos == 4) {
        Swal.fire({
          position: "top-end",
          icon: "error",
          title: "Categoría no se pudo actualizar",
          showConfirmButton: false,
          timer: 1500,
        });
      } else if (datos == 2) {
        Swal.fire({
          position: "top-end",
          icon: "error",
          title: "No se pudo registrar la Categoría",
          showConfirmButton: false,
          timer: 1500,
        });
      }
      mostrarform(false);
      tabla.ajax.reload();
    },
  });
  limpiar();
}

function mostrar(idcategoria) {
  $.post(
    "../controller/categoria.php?op=mostrar",
    { idcategoria: idcategoria },
    function (data, status) {
      data = JSON.parse(data);
      mostrarform(true);

      $("#nombre").val(data.nombre);
      $("#descripcion").val(data.descripcion);
      $("#idcategoria").val(data.idcategoria);
    }
  );
}

//Función para desactivar registros
function desactivar(idcategoria) {
  const swalWithBootstrapButtons = Swal.mixin({
    customClass: {
      confirmButton: "btn btn-success",
      cancelButton: "btn btn-danger",
    },
    buttonsStyling: false,
  });
  swalWithBootstrapButtons
    .fire({
      title: "DESACTIVAR CATEGORÍA",
      text: "Esta acción influye sobre los datos del Sistema",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Si, Desactivar!",
      cancelButtonText: "No, cancelar!",
      reverseButtons: true,
    })
    .then((result) => {
      if (result.isConfirmed) {
        $.post(
          "../controller/categoria.php?op=desactivar",
          {
            idcategoria: idcategoria,
          },
          function (e) {
            tabla.ajax.reload();
          }
        );
        swalWithBootstrapButtons.fire(
          "Mensaje!",
          "Desactivado con exito.",
          "success"
        );
      } else if (
        /* Read more about handling dismissals below */
        result.dismiss === Swal.DismissReason.cancel
      ) {
        swalWithBootstrapButtons.fire(
          "CANCELAR",
          "Se cancelo la desactivación",
          "error"
        );
      }
    });
}

//Función para activar registros
function activar(idcategoria) {
  const swalWithBootstrapButtons = Swal.mixin({
    customClass: {
      confirmButton: "btn btn-success",
      cancelButton: "btn btn-danger",
    },
    buttonsStyling: false,
  });
  swalWithBootstrapButtons
    .fire({
      title: "ACTIVAR CATEGORÍA",
      text: "Esta acción influye sobre los datos Sistema",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Si, Activar!",
      cancelButtonText: "No, cancelar!",
      reverseButtons: true,
    })
    .then((result) => {
      if (result.isConfirmed) {
        $.post(
          "../controller/categoria.php?op=activar",
          {
            idcategoria: idcategoria,
          },
          function (e) {
            tabla.ajax.reload();
          }
        );
        swalWithBootstrapButtons.fire(
          "Mensaje!",
          "Activado con exito.",
          "success"
        );
      } else if (
        /* Read more about handling dismissals below */
        result.dismiss === Swal.DismissReason.cancel
      ) {
        swalWithBootstrapButtons.fire(
          "CANCELAR",
          "Se cancelo la activación",
          "error"
        );
      }
    });
}

init();
